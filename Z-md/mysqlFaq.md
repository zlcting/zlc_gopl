# **mysql 相关知识总结**
mysql的常考的知识点主要集中在 索引 事务 隔离级别 锁机制 数据库引擎 等几个方面

### 一.首先，先来看一下索引访问的知识 这也是最重要和面试最常遇到的问题

问题1：你都知道那些索引类型（经常被问到）
如果你这样答：“唯一索引 主键索引 普通索引 复合索引” 不好意思不完全

正确姿势应该是 

从物理存储角度:
 聚簇索引和非聚簇索引
从数据结构角度:
 B+树索引、hash索引、FULLTEXT索引、R-Tree索引
从逻辑角度:
主键索引：主键索引是一种特殊的唯一索引，不允许有空值
普通索引或者单列索引
多列索引（复合索引）：复合索引指多个字段上创建的索引，只有在查询条件中使用了创建索引时的第一个字段，索引才会被使用。使用复合索引时遵循最左前缀集合
唯一索引或者非唯一索引
空间索引：空间索引是对空间数据类型的字段建立的索引，MYSQL中的空间数据类型有4种，分别是GEOMETRY、POINT、LINESTRING、POLYGON。

我们来简单介绍一下各种索引包含的相关知识
#### 1.聚簇索引和非聚簇索引
创建的索引，如复合索引、前缀索引、唯一索引，都是属于非聚簇索引，在有的书籍中，又将其称为辅助索引(secondary index)。在后文中，我们称其为非聚簇索引，其数据结构为B+树。
那么，这个聚簇索引，在Mysql中是没有语句来另外生成的。在Innodb中，Mysql中的数据是按照主键的顺序来存放的。那么聚簇索引就是按照每张表的主键来构造一颗B+树，叶子节点存放的就是整张表的行数据。由于表里的数据只能按照一颗B+树排序，因此一张表只能有一个聚簇索引。
在Innodb中，聚簇索引默认就是主键索引。

ps：如果没有主键，会用一个唯一且不为空的索引列做为主键，成为此表的聚簇索引 如果没有这样的索引，InnoDB会隐式定义一个主键来作为聚簇索引

ps：自增主键和uuid作为主键的区别么？
由于主键使用了聚簇索引，如果主键是自增id，，那么对应的数据一定也是相邻地存放在磁盘上的，写入性能比较高。如果是uuid的形式，频繁的插入会使innodb频繁地移动磁盘块，写入性能就比较低了

#### **2.我们应如何创建索引**
1）索引不是越多越好，冗余的索引不仅会增加磁盘空间，而且还会影响insert update del 等性能
2）少量的数据尽量不使用索引，数据量比较少的时候遍历的时间可能比查询索引的时间还要短
3）在条件表达式中经常用到不同值较多的列上创建索引，在不同值很少的列上不要建立索引。比如性别字段只有“男”“女”俩个值，就无需建立索引。如果建立了索引不但不会提升效率，反而严重减低数据的更新速度
4）在频繁进行排序或者分组的列上建立索引，如果排序的列有多个，可以在这些列上建立联合索引。

#### 3.mysql索引是什么结构的？
答 ：B+ Tree

![图片](https://mmbiz.qpic.cn/mmbiz_png/SYoYmIOcI5pNETceKAjvsqX8QNKR8ib9JXJObPtDTOcYYOEM0oQH1krZ6gqcGqT2hoc78RiaSUpvx1JbAPISo5Nw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1
)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/SYoYmIOcI5pNETceKAjvsqX8QNKR8ib9JXmvXI7D577A8KVD24sEByOg3gRW5MGh1B00OVoQn0rM0DHdpiazb5tw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1
)
注意一下B+ tree的两个明显特点

数据只出现在叶子节点

所有叶子节点增加了一个链指针

接下来就可以开始编了～～比如数据库索引采用B+ tree的主要原因是B Tree在提高了磁盘IO性能的同时并没有解决元素遍历的效率低下的问题。正是为了解决这个问题，B+ tree应运而生。B+ tree只要遍历叶子节点就可以实现整棵树的遍历。而且在数据库中基于范围的查询是非常频繁的，如果使用B Tree，则需要做局部的中序遍历，可能要跨层访问，效率太慢。

#### 4.联合索引和单列索引（到底为啥联合索引要遵循最左原则）
假设这是一个多列索引(col1, col2,col3)，对于叶子节点，col1表示的是年龄，col2表示的是姓氏，col3表示的是名字。如下图：
联合索引(col1, col2,col3)也是一棵B+Tree，其非叶子节点存储的是第一个关键字的索引，而叶节点存储的则是三个关键字col1、col2、col3三个关键字的数据，且按照col1、col2、col3的顺序进行排序。
![图片](https://raw.githubusercontent.com/zlcting/zlc_gopl/master/Z-md/img/Jointindex_structure.png)

如图，联合索引(年龄, 姓氏,名字)，叶节点上data域存储的是三个关键字的数据。且是按照年龄、姓氏、名字的顺序排列的。

因此，如果执行的是：
select * from STUDENT where 姓氏='李' and 名字='安';
或者
select * from STUDENT where 名字='安';
那么当执行查询的时候，是无法使用这个联合索引的。因为联合索引中是先根据年龄进行排序的。如果年龄没有先确定，直接对姓氏和名字进行查询的话，就相当于乱序查询一样，因此索引无法生效。因此查询是全表查询。

如果执行的是：
select * from STUDENT where 年龄=1 and 姓氏='李';
那么当执行查询的时候，索引是能生效的，从图中很直观的看出，age=1的是第一个叶子节点的前6条记录，在age=1的前提下，姓氏=’李’的是前3条。因此最终查询出来的是这三条，从而能获取到对应记录的地址。
如果执行的是：
select * from STUDENT where 年龄=1 and 姓氏='黄' and 名字='安';
那么索引也是生效的。

而如果执行的是：
select * from STUDENT where 年龄=1 and 名字='安';
那么，索引年龄部分能生效，名字部分不能生效。也就是说索引部分生效。

因此我对联合索引结构的理解就是B+Tree是按照第一个关键字进行索引，然后在叶子节点上按照第一个关键字、第二个关键字、第三个关键字…进行排序。

**而之所以会有最左原则，是因为联合索引的B+Tree是按照第一个关键字进行索引排列的**


#### 5.mysql某表建了多个单索引，查询多个条件时如何走索引的？（- -! 还没搞懂 待续）
有兴趣的大家可以看看下面这个链接
https://mp.weixin.qq.com/s?__biz=MzIwMDgzMjc3NA==&mid=2247484489&idx=1&sn=b4078d168dfe86d992a5eca26b1e4f4b&chksm=96f66620a181ef362a285dcfb06dedcc07c4ef93edc6784c3466568e2eb4715ac471467dec42&scene=21#wechat_redirect


## 二 隔离级别


问：“讲讲mysql有几个事务隔离级别？” 
你：“读未提交，读已提交，可重复读，串行化四个！默认是可重复读” 
问：“为什么mysql选可重复读作为默认的隔离级别？” 
(你面露苦色，不知如何回答！) 
问:"你们项目中选了哪个隔离级别？为什么？" 
你：“当然是默认的可重复读，至于原因。。呃。。。” (然后你就可以回去等通知了！)
https://zhuanlan.zhihu.com/p/59061106

## 三 锁机制与事务
https://zhuanlan.zhihu.com/p/65281198